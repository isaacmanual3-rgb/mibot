{% extends "base.html" %}

{% block title %}Doge Pixel - Wallet{% endblock %}

{% block content %}
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;500;600&display=swap');

:root {
  --bg:        #08080f;
  --surface:   #0d0d1a;
  --surface2:  #111122;
  --surface3:  #070710;
  --gold:      #ffd700;
  --gold2:     #ffb300;
  --gold-dark: #5a3a00;
  --gold-dim:  rgba(255,215,0,0.07);
  --green:     #00e676;
  --blue:      #40c4ff;
  --red:       #ff4d6a;
  --orange:    #ff9800;
  --border:    #1e1e34;
  --text:      #e0e2f0;
  --text2:     #9090b8;
  --muted:     #4a4a6e;
  --font-px:   'Press Start 2P', monospace;
  --font-body: 'Inter', sans-serif;
}

.wl-shell *, .wl-shell *::before, .wl-shell *::after { box-sizing: border-box; }

.wl-shell {
  font-family: var(--font-body);
  background: var(--bg);
  min-height: 100vh;
  color: var(--text);
  position: relative; overflow-x: hidden;
}
.wl-shell::before {
  content: ''; position: fixed; inset: 0;
  background-image:
    linear-gradient(rgba(255,255,255,0.011) 1px, transparent 1px),
    linear-gradient(90deg,rgba(255,255,255,0.011) 1px, transparent 1px);
  background-size: 24px 24px; pointer-events: none; z-index: 0;
}
.wl-shell::after {
  content: ''; position: fixed; inset: 0;
  background: repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.055) 2px,rgba(0,0,0,0.055) 4px);
  pointer-events: none; z-index: 1;
}

/* TICKER */
.wl-ticker {
  position: relative; z-index: 20;
  background: var(--gold); height: 28px;
  display: flex; align-items: center; overflow: hidden;
  border-bottom: 3px solid var(--gold-dark);
}
.wl-ticker span {
  display: inline-block; white-space: nowrap;
  font-family: var(--font-px); font-size: 0.42rem;
  color: #0a0800; letter-spacing: 0.08em;
  animation: wl-tick 30s linear infinite;
}
@keyframes wl-tick { from{transform:translateX(100vw)} to{transform:translateX(-100%)} }

/* PAGE */
.wl-page {
  position: relative; z-index: 5;
  max-width: 560px; margin: 0 auto;
  padding: 20px 14px 80px;
  display: flex; flex-direction: column; gap: 14px;
}

/* CARD */
.wl-card {
  background: var(--surface);
  border: 2px solid var(--border);
  box-shadow: 4px 4px 0 0 #030308;
  position: relative; padding: 20px;
  animation: wl-up .3s ease both;
}
.wl-card::before,.wl-card::after {
  content:''; position:absolute; width:9px; height:9px;
  border-color:var(--gold); border-style:solid;
}
.wl-card::before{top:-2px;left:-2px;border-width:2px 0 0 2px}
.wl-card::after{bottom:-2px;right:-2px;border-width:0 2px 2px 0}
.wl-card:nth-child(1){animation-delay:.04s}
.wl-card:nth-child(2){animation-delay:.09s}
.wl-card:nth-child(3){animation-delay:.14s}
.wl-card:nth-child(4){animation-delay:.19s}
@keyframes wl-up { from{opacity:0;transform:translateY(10px)} to{opacity:1;transform:translateY(0)} }

.wl-label {
  font-family: var(--font-px); font-size: 0.42rem;
  color: var(--muted); letter-spacing: 0.18em; text-transform: uppercase;
  display: flex; align-items: center; gap: 8px; margin-bottom: 16px;
}
.wl-label::after { content:''; flex:1; height:1px; background:var(--border); }

/* ═══════════════════════════════
   CSS PIXEL ICONS
═══════════════════════════════ */
.px-icon {
  display:flex; align-items:center; justify-content:center;
  width:22px; height:22px; flex-shrink:0;
}
.px-icon svg {
  width:100%; height:100%; display:block;
}

/* ═══════════════════════════════
   BALANCE HERO CARD
═══════════════════════════════ */
.wl-hero {
  background: linear-gradient(160deg, #06080f 0%, #080c18 60%, #050a14 100%);
  border: 1px solid rgba(0,152,234,0.35);
  box-shadow: 0 0 0 1px rgba(0,152,234,0.08), 0 8px 40px rgba(0,152,234,0.12), inset 0 1px 0 rgba(0,152,234,0.1);
  padding: 28px 20px 24px;
  text-align: center; position: relative; overflow: hidden;
  animation: wl-up .3s .04s ease both;
}
/* corner accents */
.wl-hero::before,.wl-hero::after {
  content:''; position:absolute; width:12px; height:12px;
  border-color:rgba(0,152,234,0.6); border-style:solid;
}
.wl-hero::before{top:-1px;left:-1px;border-width:2px 0 0 2px}
.wl-hero::after{bottom:-1px;right:-1px;border-width:0 2px 2px 0}

.wl-hero-glow {
  position:absolute; top:-60px; left:50%; transform:translateX(-50%);
  width:280px; height:280px;
  background:radial-gradient(circle,rgba(0,152,234,0.13) 0%,transparent 65%);
  pointer-events:none;
}

/* TON icon container */
.wl-hero-icon {
  width: 64px; height: 64px;
  background: linear-gradient(145deg, #0a1628, #0d1e38);
  border: 1px solid rgba(0,152,234,0.4);
  box-shadow: 0 0 20px rgba(0,152,234,0.25), inset 0 1px 0 rgba(0,152,234,0.15);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto 18px;
}

.wl-balance-amount {
  font-family: var(--font-px);
  font-size: 1.4rem;
  color: #0098EA;
  text-shadow: 0 0 30px rgba(0,152,234,0.5), 0 0 60px rgba(0,152,234,0.2);
  margin-bottom: 6px;
  line-height: 1.2;
  animation: wl-flicker 5s ease infinite;
}
@keyframes wl-flicker {
  0%,91%,93%,95%,100%{opacity:1} 92%,94%{opacity:0.55}
}
.wl-balance-label {
  font-family: var(--font-px); font-size: 0.38rem;
  color: rgba(0,152,234,0.7); letter-spacing: 0.2em; margin-bottom: 20px;
}

.wl-mini-stats {
  display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
}
.wl-mini-stat {
  background: rgba(0,152,234,0.04);
  border: 1px solid rgba(0,152,234,0.15);
  padding: 10px 8px; text-align: center;
  border-radius: 2px;
}
.wl-mini-stat .val {
  display: block; font-family: var(--font-px); font-size: 0.56rem;
  color: rgba(0,152,234,0.9); margin-bottom: 4px;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.wl-mini-stat .lbl {
  display: block; font-size: 0.6rem; color: var(--muted);
  letter-spacing: 0.06em; text-transform: uppercase;
}

/* ═══════════════════════════════
   ACTION BUTTONS
═══════════════════════════════ */
.wl-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 14px; }

.wl-btn {
  display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px;
  padding: 18px 12px 14px;
  font-family: var(--font-px); font-size: 0.44rem;
  letter-spacing: 0.1em; border: none; cursor: pointer;
  text-align: center; text-decoration: none;
  transition: transform .08s, box-shadow .08s, background .12s;
  position: relative; overflow: hidden;
}
.wl-btn::after {
  content:''; position:absolute; inset:0;
  background: linear-gradient(180deg, rgba(255,255,255,0.06) 0%, transparent 50%);
  pointer-events:none;
}
.wl-btn:hover  { transform: translateY(-2px); }
.wl-btn:active { transform: translateY(1px); }

/* WITHDRAW — gold premium */
.wl-btn-gold {
  background: linear-gradient(160deg, #2a1f00, #1a1300);
  color: #ffd700;
  border: 1px solid rgba(255,215,0,0.5);
  box-shadow: 0 0 0 1px rgba(255,215,0,0.1), 0 4px 20px rgba(255,165,0,0.2), inset 0 1px 0 rgba(255,215,0,0.15);
}
.wl-btn-gold .px-icon svg { filter: drop-shadow(0 0 6px rgba(255,215,0,0.6)); }
.wl-btn-gold:hover {
  background: linear-gradient(160deg, #352700, #221a00);
  box-shadow: 0 0 0 1px rgba(255,215,0,0.2), 0 6px 28px rgba(255,165,0,0.35), inset 0 1px 0 rgba(255,215,0,0.2);
}
.wl-btn-gold:active { transform: translateY(1px); box-shadow: 0 0 0 1px rgba(255,215,0,0.15), 0 2px 10px rgba(255,165,0,0.2); }

/* {{ t.wl_deposit_title }} — blue TON style */
.wl-btn-ton {
  background: linear-gradient(160deg, #001a30, #001020);
  color: #0098EA;
  border: 1px solid rgba(0,152,234,0.45);
  box-shadow: 0 0 0 1px rgba(0,152,234,0.08), 0 4px 20px rgba(0,152,234,0.18), inset 0 1px 0 rgba(0,152,234,0.12);
}
.wl-btn-ton .px-icon svg { filter: drop-shadow(0 0 6px rgba(0,152,234,0.7)); }
.wl-btn-ton:hover {
  background: linear-gradient(160deg, #002040, #001528);
  color: #40c4ff;
  box-shadow: 0 0 0 1px rgba(0,152,234,0.2), 0 6px 28px rgba(0,152,234,0.3), inset 0 1px 0 rgba(0,152,234,0.18);
}
.wl-btn-ton:active { transform: translateY(1px); box-shadow: 0 0 0 1px rgba(0,152,234,0.15), 0 2px 10px rgba(0,152,234,0.2); }

/* label under icon */
.wl-btn .btn-label { display:block; }
.wl-btn .btn-sub { display:block; font-size:0.32rem; opacity:0.55; margin-top:2px; letter-spacing:0.08em; }

/* Min withdrawal info */
.wl-fee-box {
  background: var(--surface3);
  border: 2px solid var(--border);
  padding: 14px 16px;
  display: flex; justify-content: space-between; align-items: center;
}
.wl-fee-left { }
.wl-fee-label {
  display: block; font-family: var(--font-px); font-size: 0.38rem;
  color: var(--muted); letter-spacing: 0.12em; margin-bottom: 6px;
}
.wl-fee-value {
  display: block; font-family: var(--font-px); font-size: 0.7rem;
  color: var(--blue); text-shadow: 0 0 8px rgba(64,196,255,0.3);
}
.wl-fee-right { font-size: 0.72rem; color: var(--text2); text-align: right; }
.wl-fee-right span { display: block; color: var(--muted); font-size: 0.65rem; margin-bottom: 2px; }

/* ═══════════════════════════════
   TRANSACTION LIST
═══════════════════════════════ */
.wl-tx-list { display: flex; flex-direction: column; gap: 8px; }

.wl-tx {
  background: var(--surface3);
  border: 2px solid var(--border);
  box-shadow: 2px 2px 0 0 #020205;
  display: flex; align-items: center; gap: 12px;
  padding: 12px 14px; position: relative;
}
.wl-tx::before {
  content:''; position:absolute; left:0; top:0; bottom:0;
  width: 3px;
}
.wl-tx.credit::before { background: var(--green); }
.wl-tx.debit::before  { background: var(--red); }

.wl-tx-icon {
  flex-shrink: 0; width: 36px; height: 36px;
  background: var(--surface);
  border: 2px solid var(--border);
  display: flex; align-items: center; justify-content: center;
}
.wl-tx.credit .wl-tx-icon { background: rgba(0,230,118,0.06); border-color: rgba(0,230,118,0.2); }
.wl-tx.debit  .wl-tx-icon { background: rgba(255,77,106,0.06); border-color: rgba(255,77,106,0.2); }

.wl-tx-body { flex: 1; min-width: 0; }
.wl-tx-action {
  display: block; font-family: var(--font-px); font-size: 0.44rem;
  color: var(--text); letter-spacing: 0.04em; margin-bottom: 5px;
  overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
}
.wl-tx-time { font-size: 0.65rem; color: var(--muted); }

.wl-tx-amount {
  flex-shrink: 0; font-family: var(--font-px); font-size: 0.52rem;
  text-align: right;
}
.wl-tx-amount.credit { color: var(--green); text-shadow: 0 0 8px rgba(0,230,118,0.3); }
.wl-tx-amount.debit  { color: var(--red); }

/* Withdrawal status badge */
.wl-wd-badge {
  display: block; margin-top: 5px;
  font-family: var(--font-px); font-size: 0.34rem;
  letter-spacing: 0.06em; padding: 3px 6px;
  border: 1px solid; text-align: right;
}
.wl-wd-badge.completed { color: var(--green); border-color: rgba(0,230,118,0.3); background: rgba(0,230,118,0.05); }
.wl-wd-badge.pending   { color: var(--orange); border-color: rgba(255,152,0,0.3); background: rgba(255,152,0,0.05); }
.wl-wd-badge.rejected  { color: var(--red); border-color: rgba(255,77,106,0.3); background: rgba(255,77,106,0.05); }

/* Empty */
.wl-empty {
  padding: 40px 20px; text-align: center;
}
.wl-empty-icon {
  width: 42px; height: 42px; background: var(--surface3); border: 2px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  margin: 0 auto 16px;
  animation: wl-bounce .9s steps(1) infinite;
}
@keyframes wl-bounce { 0%,100%{transform:translateY(0)} 50%{transform:translateY(-5px)} }
.wl-empty-title { font-family: var(--font-px); font-size: 0.5rem; color: var(--text2); letter-spacing:.06em; margin-bottom:10px; }
.wl-empty-hint  { font-size: 0.78rem; color: var(--muted); }

/* ═══════════════════════════════
   WITHDRAW MODAL (bottom sheet)
═══════════════════════════════ */
.modal-overlay {
  display: none; position: fixed; inset: 0;
  background: rgba(4,4,10,0.9); z-index: 100;
  align-items: flex-end; justify-content: center;
}
.modal-overlay.active, .modal-overlay.show { display: flex; animation: wl-modal-bg .2s ease; }
@keyframes wl-modal-bg { from{opacity:0} to{opacity:1} }

.modal-content {
  background: var(--surface2);
  border: 2px solid var(--border); border-bottom: none;
  box-shadow: 0 -6px 40px rgba(0,0,0,0.7);
  width: 100%; max-width: 560px;
  padding: 28px 20px 32px;
  position: relative;
  animation: wl-sheet .25s cubic-bezier(.22,.77,.42,1) both;
}
@keyframes wl-sheet {
  from{transform:translateY(60px);opacity:0}
  to{transform:translateY(0);opacity:1}
}
.modal-content::before,.modal-content::after {
  content:''; position:absolute; width:9px; height:9px;
  border-color:var(--gold); border-style:solid;
}
.modal-content::before{top:-2px;left:-2px;border-width:2px 0 0 2px}
.modal-content::after{top:-2px;right:-2px;border-width:2px 2px 0 0}

.modal-handle {
  width: 36px; height: 4px; background: var(--border);
  margin: 0 auto 22px;
}

.modal-header {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 20px;
}
.modal-title {
  font-family: var(--font-px); font-size: 0.6rem;
  color: var(--gold); text-shadow: 1px 1px 0 var(--gold-dark);
  letter-spacing: 0.06em;
  display: flex; align-items: center; gap: 10px;
}
.modal-close {
  width: 30px; height: 30px;
  background: var(--surface3); border: 2px solid var(--border);
  color: var(--text2); font-size: 1rem; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: transform .07s; font-family: var(--font-body);
}
.modal-close:hover { color: var(--red); border-color: rgba(255,77,106,0.4); transform: scale(0.95); }

.form-group { margin-bottom: 16px; }
.form-label {
  display: block; font-family: var(--font-px); font-size: 0.38rem;
  color: var(--muted); letter-spacing: 0.14em;
  text-transform: uppercase; margin-bottom: 8px;
}
.form-input {
  width: 100%; background: var(--surface3);
  border: 2px solid var(--border);
  box-shadow: inset 2px 2px 0 0 #020205;
  padding: 12px 14px;
  font-family: var(--font-body); font-size: 0.88rem;
  color: var(--text); outline: none;
  transition: border-color .15s;
}
.form-input:focus { border-color: var(--gold-dark); }
.form-hint { font-size: 0.72rem; color: var(--muted); margin-top: 5px; }

.wl-fee-summary {
  background: var(--surface3);
  border: 2px solid var(--border);
  padding: 14px; margin-bottom: 20px;
  display: flex; flex-direction: column; gap: 8px;
}
.wl-fee-row {
  display: flex; justify-content: space-between; align-items: center;
}
.wl-fee-row-label { font-size: 0.72rem; color: var(--text2); }
.wl-fee-row-val { font-family: var(--font-px); font-size: 0.44rem; }
.wl-fee-row-val.warn  { color: var(--orange); }
.wl-fee-row-val.good  { color: var(--green); text-shadow: 0 0 8px rgba(0,230,118,0.3); }

.modal-footer {
  display: grid; grid-template-columns: 1fr 2fr; gap: 10px;
}
.wl-btn-cancel {
  font-family: var(--font-px); font-size: 0.44rem; letter-spacing: .06em;
  padding: 14px; background: transparent; color: var(--text2);
  border: 2px solid var(--border); box-shadow: 2px 2px 0 0 #030308;
  cursor: pointer; transition: transform .07s, box-shadow .07s;
}
.wl-btn-cancel:hover  { transform: translate(-1px,-1px); box-shadow: 3px 3px 0 0 #030308; }
.wl-btn-cancel:active { transform: translate(1px,1px); }
.wl-btn-confirm {
  font-family: var(--font-px); font-size: 0.5rem; letter-spacing: .06em;
  padding: 14px; background: var(--gold); color: #0a0800;
  border: 2px solid var(--gold2); box-shadow: 3px 3px 0 0 var(--gold-dark);
  cursor: pointer;
  display: flex; align-items: center; justify-content: center; gap: 8px;
  transition: transform .07s, box-shadow .07s;
}
.wl-btn-confirm:hover  { transform: translate(-1px,-1px); box-shadow: 4px 4px 0 0 var(--gold-dark); }
.wl-btn-confirm:active { transform: translate(2px,2px); box-shadow: 1px 1px 0 0 var(--gold-dark); }
.wl-btn-confirm:disabled { opacity: .5; cursor: not-allowed; transform: none; }
</style>

<div class="wl-shell">
  <div class="wl-ticker" aria-hidden="true">
    <span>
      ★ WALLET ★&nbsp;&nbsp;
      CHECK YOUR TON BALANCE &nbsp;★&nbsp;&nbsp;
      WITHDRAW TO YOUR OWN WALLET &nbsp;★&nbsp;&nbsp;
      EARN MORE WITH TASKS &amp; REFERRALS &nbsp;★&nbsp;&nbsp;
      MUCH BALANCE. VERY RICH. SO TON. &nbsp;★&nbsp;&nbsp;
    </span>
  </div>

  <div class="wl-page">

    <!-- ── BALANCE HERO ── -->
    <div class="wl-hero">
      <div class="wl-hero-glow" aria-hidden="true"></div>
      <div class="wl-hero-icon">
        <!-- Logo TON real: círculo azul + triángulo redondeado invertido con T -->
        <svg viewBox="0 0 56 56" fill="none" width="40" height="40"><circle cx="28" cy="28" r="28" fill="#0098EA"/><path d="M17 16 Q17 13.5 19.5 13.5 L36.5 13.5 Q39 13.5 39 16 Q39 18 37.5 19.5 L29.5 40 Q28.8 42 28 42 Q27.2 42 26.5 40 L18.5 19.5 Q17 18 17 16 Z" fill="none" stroke="white" stroke-width="3.2" stroke-linejoin="round"/><line x1="28" y1="17.5" x2="28" y2="35" stroke="white" stroke-width="3.2" stroke-linecap="round"/></svg>
      </div>
      <div class="wl-balance-amount">
        {{ format_ton(user.doge_balance) }}
      </div>
      <div class="wl-balance-label">{{ t.wl_ton_balance }}</div>
      <div class="wl-mini-stats">
        <div class="wl-mini-stat">
          <span class="val">{{ format_ton(user.total_earned) }} TON</span>
          <span class="lbl">{{ t.wl_total_earned }}</span>
        </div>
        <div class="wl-mini-stat">
          <span class="val">{{ format_ton(user.referral_earnings or 0) }} TON</span>
          <span class="lbl">{{ t.wl_from_referrals }}</span>
        </div>
      </div>
    </div>

    <!-- ── ACTIONS ── -->
    <div class="wl-card">
      {% set btn_count = 1 + (1 if ton_enabled else 0) %}
      <div class="wl-actions" style="grid-template-columns: repeat({{ btn_count }}, 1fr)">

        <button class="wl-btn wl-btn-gold" onclick="openWithdrawModal()">
          <span class="px-icon">
            <svg viewBox="0 0 56 56" fill="none" width="26" height="26">
              <circle cx="28" cy="28" r="28" fill="#0098EA"/>
              <path d="M17 16 Q17 13.5 19.5 13.5 L36.5 13.5 Q39 13.5 39 16 Q39 18 37.5 19.5 L29.5 40 Q28.8 42 28 42 Q27.2 42 26.5 40 L18.5 19.5 Q17 18 17 16 Z" fill="none" stroke="white" stroke-width="3.2" stroke-linejoin="round"/>
              <line x1="28" y1="17.5" x2="28" y2="35" stroke="white" stroke-width="3.2" stroke-linecap="round"/>
            </svg>
          </span>
          <span class="btn-label">{{ t.wl_withdraw_btn }}</span>
          <span class="btn-sub">{{ t.wl_withdraw_desc }}</span>
        </button>

        {% if ton_enabled %}
        <button class="wl-btn wl-btn-ton" id="ton-deposit-btn">
          <span class="px-icon">
            <svg viewBox="0 0 56 56" fill="none" width="26" height="26"><circle cx="28" cy="28" r="28" fill="#0098EA"/><path d="M17 16 Q17 13.5 19.5 13.5 L36.5 13.5 Q39 13.5 39 16 Q39 18 37.5 19.5 L29.5 40 Q28.8 42 28 42 Q27.2 42 26.5 40 L18.5 19.5 Q17 18 17 16 Z" fill="none" stroke="white" stroke-width="3.2" stroke-linejoin="round"/><line x1="28" y1="17.5" x2="28" y2="35" stroke="white" stroke-width="3.2" stroke-linecap="round"/></svg>
          </span>
          <span class="btn-label">{{ t.wl_deposit_btn }}</span>
          <span class="btn-sub">{{ t.wl_deposit_desc }}</span>
        </button>
        {% endif %}
      </div>
    </div>

    <!-- ── WITHDRAWAL REQUESTS ── -->
    {% if withdrawals %}
    <div class="wl-card">
      <div class="wl-label">
        <span class="px-icon" style="margin-right:4px"><svg viewBox="0 0 24 24" fill="none" stroke="#ff9800" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></span>
        {{ t.wl_transactions }}
      </div>
      <div class="wl-tx-list">
        {% for wd in withdrawals %}
        <div class="wl-tx debit">
          <div class="wl-tx-icon">
            <span class="px-icon"><svg viewBox="0 0 24 24" fill="none" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M19 12l-7 7-7-7"/><path d="M5 5h14" stroke-width="2"/></svg></span>
          </div>
          <div class="wl-tx-body">
            <span class="wl-tx-action">{{ wd.withdrawal_id }}</span>
            <span class="wl-tx-time">{{ wd.created_at | timeago }}</span>
          </div>
          <div style="text-align:right">
            <div class="wl-tx-amount debit">-{{ format_ton(wd.amount) }}</div>
            <span class="wl-wd-badge {% if wd.status == 'completed' %}completed{% elif wd.status == 'pending' %}pending{% else %}rejected{% endif %}">
              {{ wd.status | upper }}
            </span>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- ── {{ t.wl_transactions }} ── -->
    <div class="wl-card">
      <div class="wl-label">
        <span class="px-icon" style="margin-right:4px"><svg viewBox="0 0 24 24" fill="none" stroke="#40c4ff" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="8" y1="13" x2="16" y2="13"/><line x1="8" y1="17" x2="13" y2="17"/></svg></span>
        {{ t.wl_transactions }}
      </div>

      {% if history %}
      <div class="wl-tx-list">
        {% for tx in history %}
        <div class="wl-tx {% if tx.amount > 0 %}credit{% else %}debit{% endif %}">
          <div class="wl-tx-icon">
            {% if tx.amount > 0 %}
              <span class="px-icon"><svg viewBox="0 0 24 24" fill="none" stroke="#00e676" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12l7 7 7-7"/></svg></span>
            {% else %}
              <span class="px-icon"><svg viewBox="0 0 24 24" fill="none" stroke="#ff4d6a" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 19V5M5 12l7-7 7 7"/></svg></span>
            {% endif %}
          </div>
          <div class="wl-tx-body">
            <span class="wl-tx-action">{{ tx.action | replace('_', ' ') | title }}</span>
            <span class="wl-tx-time">{{ tx.created_at | timeago }}</span>
          </div>
          <div class="wl-tx-amount {% if tx.amount > 0 %}credit{% else %}debit{% endif %}">
            {% if tx.amount > 0 %}+{% endif %}{{ format_ton(tx.amount) }}
          </div>
        </div>
        {% endfor %}
      </div>

      {% else %}
      <div class="wl-empty">
        <div class="wl-empty-icon">
          <span class="px-icon"><svg viewBox="0 0 24 24" fill="none" stroke="#555570" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 16 12 14 15 10 15 8 12 2 12"/><path d="M5.45 5.11L2 12v6a2 2 0 002 2h16a2 2 0 002-2v-6l-3.45-6.89A2 2 0 0016.76 4H7.24a2 2 0 00-1.79 1.11z"/></svg></span>
        </div>
        <div class="wl-empty-title">{{ t.wl_no_transactions }}</div>
        <div class="wl-empty-hint">{{ t.wl_complete_tasks }}</div>
      </div>
      {% endif %}
    </div>

  </div>
</div>

<!-- ── WITHDRAW MODAL ── -->
<div class="modal-overlay" id="withdraw-modal">
  <div class="modal-content">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title">
        <span class="px-icon"><svg viewBox="0 0 24 24" fill="none" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M19 12l-7 7-7-7"/><path d="M5 5h14" stroke-width="2"/></svg></span>
        {{ t.wl_withdraw_title }}
      </span>
      <button class="modal-close" onclick="DogeQuest.closeModal('withdraw-modal')">×</button>
    </div>

    <div class="modal-body">
      <div class="form-group">
        <label class="form-label">{{ t.wl_amount }}</label>
        <input type="number" id="withdraw-amount" class="form-input"
               placeholder="{{ t.wl_amount_placeholder }}"
               min="{{ min_withdrawal }}" step="0.00000001"
               value="{{ min_withdrawal }}">
        <div class="form-hint">{{ t.wl_available }}: {{ format_ton(user.doge_balance) }} TON</div>
      </div>

      <div class="form-group">
        <label class="form-label">{{ t.wl_address }}</label>
        <input type="text" id="withdraw-wallet" class="form-input"
               placeholder="D..."
               value="{{ user.wallet_address or '' }}">
        <div class="form-hint">{{ t.wl_address_hint }}</div>
      </div>

      <div class="wl-fee-summary">
        <div class="wl-fee-row">
          <span class="wl-fee-row-label">{{ t.wl_network_fee }}</span>
          <span class="wl-fee-row-val warn">{{ withdrawal_fee }} TON</span>
        </div>
        <div class="wl-fee-row">
          <span class="wl-fee-row-label">{{ t.wl_you_receive }}</span>
          <span class="wl-fee-row-val good" id="receive-amount">
            {{ format_ton(min_withdrawal - withdrawal_fee) }} TON
          </span>
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button class="wl-btn-cancel" onclick="DogeQuest.closeModal('withdraw-modal')">{{ t.wl_cancel }}</button>
      <button class="wl-btn-confirm" onclick="DogeQuest.requestWithdrawal()">
        <span class="px-icon"><svg viewBox="0 0 24 24" fill="none" stroke="#ffd700" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M19 12l-7 7-7-7"/><path d="M5 5h14" stroke-width="2"/></svg></span>
        {{ t.wl_submit_withdraw }}
      </button>
    </div>
  </div>
</div>

{% if ton_withdrawal_enabled %}
<!-- ── TON WITHDRAW MODAL ── -->
<div class="modal-overlay" id="ton-withdraw-modal">
  <div class="modal-content">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title">
        <svg viewBox="0 0 24 24" fill="none" width="20" height="20" style="flex-shrink:0"><circle cx="12" cy="12" r="10" fill="#ffd700"/><path d="M12 5v14M19 12l-7 7-7-7" stroke="#1a1a2e" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
        {{ t.wl_withdraw_title }}
      </span>
      <button class="modal-close" id="ton-wd-modal-close">×</button>
    </div>

    <!-- Paso 1: Formulario -->
    <div id="ton-wd-step-form">
      <div style="background:var(--surface3);border:2px solid #ffd700;padding:12px 14px;margin-bottom:16px;font-family:var(--font-px);font-size:0.37rem;color:#ffd700;letter-spacing:.08em;text-align:center">
        MIN: {{ ton_withdrawal_min }} TON
      </div>

      <div class="form-group">
        <label class="form-label" style="color:#ffd700">{{ t.wl_deposit_addr_lbl }}</label>
        <input type="text" id="ton-wd-address-input" class="form-input"
               placeholder="{{ t.wl_ton_addr_placeholder }}"
               autocomplete="off" spellcheck="false"
               style="font-size:0.72rem;letter-spacing:0.02em">
        <div class="form-hint">{{ t.wl_ton_addr_placeholder }}</div>
      </div>

      <div class="form-group">
        <label class="form-label">{{ t.wl_amount }}</label>
        <input type="number" id="ton-wd-amount-input" class="form-input"
               min="{{ ton_withdrawal_min }}" step="0.0001" value="{{ ton_withdrawal_min }}">
        <div class="form-hint">{{ t.wl_available }}: {{ format_ton(user.doge_balance) }} TON</div>
      </div>

      <div class="wl-fee-summary" style="margin-bottom:18px">
        <div class="wl-fee-row">
          <span class="wl-fee-row-label">{{ t.wl_you_receive }}</span>
          <span class="wl-fee-row-val" id="ton-wd-preview-doge">{{ format_ton(ton_withdrawal_min) }} TON</span>
        </div>
        <div class="wl-fee-row">
          <span class="wl-fee-row-label">Comisión ({{ ton_withdrawal_fee_pct }}%)</span>
          <span class="wl-fee-row-val warn" id="ton-wd-preview-fee">{{ format_ton(ton_withdrawal_min * ton_withdrawal_fee_pct / 100) }} TON</span>
        </div>
        <div class="wl-fee-row">
          <span class="wl-fee-row-label">{{ t.wl_you_receive }} TON</span>
          <span class="wl-fee-row-val good" id="ton-wd-preview-ton">{{ (ton_withdrawal_min * (1 - ton_withdrawal_fee_pct/100))|round(4) }} TON</span>
        </div>
      </div>

      <div id="ton-wd-addr-warning" style="display:none;background:rgba(255,77,106,0.1);border:1px solid rgba(255,77,106,0.4);padding:10px 12px;margin-bottom:14px;font-size:0.76rem;color:#ff4d6a;line-height:1.4"></div>

      <div class="modal-footer">
        <button id="ton-wd-btn-cancel" class="wl-btn-cancel">{{ t.wl_cancel }}</button>
        <button id="ton-wd-btn-submit" class="wl-btn-confirm" style="background:#c8a200;border-color:#ffd700;box-shadow:3px 3px 0 0 #7a6000;color:#1a1a2e;font-weight:bold">
          <svg viewBox="0 0 24 24" fill="none" width="16" height="16" style="flex-shrink:0"><path d="M12 5v14M19 12l-7 7-7-7" stroke="#1a1a2e" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          {{ t.wl_submit_withdraw }}
        </button>
      </div>
    </div>

    <!-- Paso 2: Procesando -->
    <div id="ton-wd-step-processing" style="display:none;text-align:center;padding:36px 0">
      <div style="width:52px;height:52px;border:3px solid #ffd700;border-top-color:transparent;border-radius:50%;animation:ton-wd-spin 1s linear infinite;margin:0 auto 20px"></div>
      <div style="font-family:var(--font-px);font-size:0.46rem;color:#ffd700;letter-spacing:.1em;margin-bottom:12px">{{ t.wl_processing_wd }}</div>
      <div style="font-size:0.8rem;color:var(--text2);line-height:1.6">Firmando y enviando la transacción TON.<br>Esto puede tomar unos segundos.</div>
      <style>@keyframes ton-wd-spin { to { transform:rotate(360deg) } }</style>
    </div>

    <!-- Paso 3: Éxito -->
    <div id="ton-wd-step-success" style="display:none;text-align:center;padding:30px 0">
      <div style="width:58px;height:58px;background:rgba(0,230,118,0.1);border:2px solid rgba(0,230,118,0.4);display:flex;align-items:center;justify-content:center;margin:0 auto 16px">
        <svg viewBox="0 0 24 24" fill="none" stroke="#00e676" stroke-width="2.5" width="28"><polyline points="20 6 9 17 4 12"/></svg>
      </div>
      <div style="font-family:var(--font-px);font-size:0.52rem;color:#00e676;margin-bottom:12px">{{ t.wl_withdrawal_sent }}</div>
      <div id="ton-wd-success-msg" style="font-size:0.82rem;color:var(--text2);line-height:1.6;margin-bottom:22px;white-space:pre-wrap"></div>
      <button id="ton-wd-btn-success-close" class="wl-btn-confirm">{{ t.wl_cancel }}</button>
    </div>

    <!-- Paso 4: Error -->
    <div id="ton-wd-step-error" style="display:none;text-align:center;padding:30px 0">
      <div style="width:52px;height:52px;background:rgba(255,77,106,0.1);border:2px solid rgba(255,77,106,0.4);display:flex;align-items:center;justify-content:center;margin:0 auto 14px">
        <svg viewBox="0 0 24 24" fill="none" stroke="#ff4d6a" stroke-width="2.5" width="26"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </div>
      <div style="font-family:var(--font-px);font-size:0.48rem;color:#ff4d6a;margin-bottom:10px">ERROR</div>
      <div id="ton-wd-error-msg" style="font-size:0.78rem;color:var(--text2);line-height:1.5;margin-bottom:18px"></div>
      <button id="ton-wd-btn-retry" class="wl-btn-confirm" style="background:#1a1a2e;border-color:#333;color:#aaa;box-shadow:none">{{ t.wl_retry }}</button>
    </div>

  </div>
</div>
{% endif %}

{% if ton_enabled %}
<!-- ── TON DEPOSIT MODAL ── -->
<div class="modal-overlay" id="ton-deposit-modal">
  <div class="modal-content">
    <div class="modal-handle"></div>
    <div class="modal-header">
      <span class="modal-title">
        <svg viewBox="0 0 56 56" fill="none" width="20" height="20" style="flex-shrink:0"><circle cx="28" cy="28" r="28" fill="#0098EA"/><path d="M17 16 Q17 13.5 19.5 13.5 L36.5 13.5 Q39 13.5 39 16 Q39 18 37.5 19.5 L29.5 40 Q28.8 42 28 42 Q27.2 42 26.5 40 L18.5 19.5 Q17 18 17 16 Z" fill="none" stroke="white" stroke-width="3.2" stroke-linejoin="round"/><line x1="28" y1="17.5" x2="28" y2="35" stroke="white" stroke-width="3.2" stroke-linecap="round"/></svg>
        {{ t.wl_deposit_title }}
      </span>
      <button class="modal-close" id="ton-modal-close">×</button>
    </div>

    <!-- PASO 1: Mostrando QR y dirección -->
    <div id="ton-step-qr">
      <div style="background:var(--surface3);border:2px solid #0098EA;padding:10px 14px;margin-bottom:14px;font-family:var(--font-px);font-size:0.37rem;color:#0098EA;letter-spacing:.08em;text-align:center">
        {{ t.wl_min_amount }}: {{ ton_min }} TON
      </div>

      <p style="font-size:0.8rem;color:var(--text2);margin-bottom:14px;line-height:1.5;text-align:center">
        {{ t.wl_deposit_from_any }}<br>
        <span style="color:#ffd700;font-size:0.75rem">{{ t.wl_dep_memo_warning }}</span>
      </p>

      <!-- QR Code -->
      <div style="text-align:center;margin-bottom:14px">
        <div id="ton-qr-container" style="display:inline-block;background:#fff;padding:10px;border:3px solid #0098EA">
          <canvas id="ton-qr-canvas" width="160" height="160"></canvas>
        </div>
      </div>

      <!-- Dirección del bot -->
      <div style="margin-bottom:12px">
        <div style="font-family:var(--font-px);font-size:0.32rem;color:var(--muted);margin-bottom:5px;letter-spacing:.08em">{{ t.wl_dep_address_lbl }}</div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="ton-dep-address" style="flex:1;background:var(--surface3);border:1px solid #333;padding:10px;font-size:0.68rem;color:#0098EA;word-break:break-all;line-height:1.4">{{ ton_wallet_address }}</div>
          <button onclick="copyDepAddr()" style="flex-shrink:0;background:#0098EA;border:none;color:#fff;padding:10px 12px;cursor:pointer;font-family:var(--font-px);font-size:0.32rem;letter-spacing:.06em" id="ton-copy-addr-btn">{{ t.wl_copy }}</button>
        </div>
      </div>

      <!-- MEMO obligatorio -->
      <div style="margin-bottom:16px">
        <div style="font-family:var(--font-px);font-size:0.32rem;color:#ffd700;margin-bottom:5px;letter-spacing:.08em">{{ t.wl_dep_memo_lbl }}</div>
        <div style="display:flex;gap:8px;align-items:center">
          <div id="ton-dep-memo" style="flex:1;background:rgba(255,215,0,0.07);border:2px solid #ffd700;padding:10px;font-family:var(--font-px);font-size:0.5rem;color:#ffd700;letter-spacing:.1em;text-align:center">{{ user_deposit_memo }}</div>
          <button onclick="copyDepMemo()" style="flex-shrink:0;background:#c8a200;border:none;color:#1a1a2e;padding:10px 12px;cursor:pointer;font-family:var(--font-px);font-size:0.32rem;letter-spacing:.06em;font-weight:bold" id="ton-copy-memo-btn">{{ t.wl_copy }}</button>
        </div>
        <div style="font-size:0.72rem;color:#ff4d6a;margin-top:6px;line-height:1.4">
          {{ t.wl_dep_memo_warn2 }}
        </div>
      </div>

      <!-- Estado de espera -->
      <div id="ton-waiting-box" style="background:rgba(0,152,234,0.08);border:1px solid rgba(0,152,234,0.3);padding:12px;text-align:center;margin-bottom:14px">
        <div style="display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:6px">
          <div id="ton-pulse" style="width:10px;height:10px;background:#0098EA;border-radius:50%;animation:ton-pulse 1.5s ease-in-out infinite"></div>
          <span style="font-family:var(--font-px);font-size:0.36rem;color:#0098EA;letter-spacing:.06em">{{ t.wl_dep_waiting }}</span>
        </div>
        <div style="font-size:0.74rem;color:var(--text2)">{{ t.wl_dep_auto_credit }}</div>
      </div>

      <button id="ton-btn-cancel" class="wl-btn-cancel" style="width:100%">{{ t.wl_cancel }}</button>
    </div>

    <!-- PASO 2: Éxito -->
    <div id="ton-step-success" style="display:none;text-align:center;padding:30px 0">
      <div style="width:58px;height:58px;background:rgba(0,230,118,0.1);border:2px solid rgba(0,230,118,0.4);display:flex;align-items:center;justify-content:center;margin:0 auto 16px">
        <svg viewBox="0 0 24 24" fill="none" stroke="#00e676" stroke-width="2.5" width="28"><polyline points="20 6 9 17 4 12"/></svg>
      </div>
      <div style="font-family:var(--font-px);font-size:0.58rem;color:#00e676;margin-bottom:10px">{{ t.wl_dep_credited }}</div>
      <div id="ton-success-msg" style="font-size:0.82rem;color:var(--text2);line-height:1.6;margin-bottom:22px;white-space:pre-wrap"></div>
      <button id="ton-btn-success-close" class="wl-btn-confirm">{{ t.wl_available }}</button>
    </div>

  </div>
</div>
<style>
  @keyframes ton-pulse { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.4);opacity:0.6} }
</style>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
/* Smart withdraw: open the right modal depending on what's enabled */
function openWithdrawModal() {
  {% if ton_withdrawal_enabled %}
    DogeQuest.openModal('ton-withdraw-modal');
  {% else %}
    DogeQuest.openModal('withdraw-modal');
  {% endif %}
}

/* Withdraw preview */
document.getElementById('withdraw-amount')?.addEventListener('input', function() {
  const a = parseFloat(this.value) || 0, fee = {{ withdrawal_fee }};
  document.getElementById('receive-amount').textContent =
    Math.max(0, a - fee).toFixed(8).replace(/\.?0+$/, '') + ' TON';
});

{% if ton_withdrawal_enabled %}
/* ─── TON Withdrawal ──────────────────────────────────────────── */
(function() {
  var FEE_PCT     = 3;
  var MIN_DOGE    = {{ ton_withdrawal_min }};
  var MAX_DOGE = {{ user.doge_balance|float }};

  function el(id) { return document.getElementById(id); }

  function showWdStep(name) {
    ['form','processing','success','error'].forEach(function(s) {
      var d = el('ton-wd-step-' + s);
      if (d) d.style.display = (s === name) ? 'block' : 'none';
    });
  }

  function isValidTonAddr(addr) {
    addr = addr.trim();
    // UQ.../EQ... base64url 48 chars, o raw hex 64 chars
    return /^[UE]Q[A-Za-z0-9_\-]{46}$/.test(addr) || /^0:[a-fA-F0-9]{64}$/.test(addr);
  }

  /* Preview actualizado */
  el('ton-wd-amount-input') && el('ton-wd-amount-input').addEventListener('input', function() {
    var d   = parseFloat(this.value) || 0;
    var fee = d * FEE_PCT / 100;
    var net = d - fee;
    el('ton-wd-preview-doge').textContent = d.toFixed(4) + ' TON';
    el('ton-wd-preview-fee').textContent  = fee.toFixed(4) + ' TON';
    el('ton-wd-preview-ton').textContent  = net.toFixed(4) + ' TON';
  });

  /* Validar dirección en tiempo real */
  el('ton-wd-address-input') && el('ton-wd-address-input').addEventListener('input', function() {
    var w = el('ton-wd-addr-warning');
    var v = this.value.trim();
    if (v.length > 5 && !isValidTonAddr(v)) {
      w.style.display = 'block';
      w.textContent = '{{ t.wl_invalid_addr_hint }}';
    } else {
      w.style.display = 'none';
    }
  });

  /* Abrir modal */
  el('ton-withdraw-btn') && el('ton-withdraw-btn').addEventListener('click', function() {
    showWdStep('form');
    DogeQuest.openModal('ton-withdraw-modal');
  });

  /* Cerrar / Cancelar */
  el('ton-wd-modal-close') && el('ton-wd-modal-close').addEventListener('click', function() { DogeQuest.closeModal('ton-withdraw-modal'); });
  el('ton-wd-btn-cancel')  && el('ton-wd-btn-cancel').addEventListener('click', function() { DogeQuest.closeModal('ton-withdraw-modal'); });
  el('ton-wd-btn-retry')   && el('ton-wd-btn-retry').addEventListener('click', function() { showWdStep('form'); });
  el('ton-wd-btn-success-close') && el('ton-wd-btn-success-close').addEventListener('click', function() { DogeQuest.closeModal('ton-withdraw-modal'); location.reload(); });

  /* Submit */
  el('ton-wd-btn-submit') && el('ton-wd-btn-submit').addEventListener('click', async function() {
    var addr    = (el('ton-wd-address-input').value || '').trim();
    var dogeAmt = parseFloat(el('ton-wd-amount-input').value || '0');

    if (!addr) { DogeQuest.showToast('{{ t.wl_enter_address }}', 'error'); return; }
    if (!isValidTonAddr(addr)) { DogeQuest.showToast('{{ t.wl_invalid_addr }}', 'error'); return; }
    if (isNaN(dogeAmt) || dogeAmt < MIN_DOGE) { DogeQuest.showToast('{{ t.wl_min_amount }} ' + MIN_DOGE + ' TON', 'error'); return; }
    if (dogeAmt > MAX_DOGE) { DogeQuest.showToast('{{ t.wl_insufficient }}', 'error'); return; }

    showWdStep('processing');

    var data = null;
    try {
      var res = await fetch('/api/ton/withdraw/init', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ doge_amount: dogeAmt, ton_wallet: addr })
      });
      if (!res.ok) {
        var errText = 'HTTP ' + res.status;
        try { var j = await res.json(); errText = j.message || errText; } catch(e){}
        throw new Error(errText);
      }
      data = await res.json();
      if (!data.success) throw new Error(data.message || 'Error al procesar retiro');

      showWdStep('success');
      var msg = '';
      if (data.auto_sent) {
        msg  = '✅ ¡TON enviado automáticamente!\n\n';
        msg += data.doge_amount.toFixed(2) + ' DOGE → ' + data.ton_amount.toFixed(4) + ' TON\n';
        msg += 'A: ' + addr;
        if (data.tx_hash) msg += '\nTX: ' + data.tx_hash.slice(0, 24) + '...';
      } else {
        msg  = '⏳ Retiro registrado y en proceso\n\n';
        msg += data.doge_amount.toFixed(2) + ' DOGE → ' + data.ton_amount.toFixed(4) + ' TON\n';
        msg += 'A: ' + addr + '\n\n';
        msg += 'ID: ' + (data.withdrawal_id || '—') + '\n';
        msg += 'El TON se enviará en los próximos minutos.';
      }
      el('ton-wd-success-msg').textContent = msg;

    } catch(err) {
      showWdStep('error');
      var errMsg = err.message || 'Error desconocido';
      if (data && data.withdrawal_id) {
        errMsg += '\n\nID: ' + data.withdrawal_id + '\n(Tu TON fue reservado, el TON se enviará manualmente)';
      }
      el('ton-wd-error-msg').textContent = errMsg;
    }
  });

})();
{% endif %}
</script>

{% if ton_enabled %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
(function() {
  var DEPOSIT_ID  = null;
  var pollTimer   = null;
  var RATE        = {{ ton_rate }};
  var MEMO        = "{{ user_deposit_memo }}";
  var ADDRESS     = "{{ ton_wallet_address }}";

  function el(id) { return document.getElementById(id); }

  function showDepStep(name) {
    ['qr','success'].forEach(function(s) {
      var d = el('ton-step-' + s);
      if (d) d.style.display = (s === name) ? 'block' : 'none';
    });
  }

  function generateQR() {
    var canvas = el('ton-qr-canvas');
    if (!canvas || !ADDRESS || ADDRESS.includes('AQUI')) return;
    // TON URI con dirección y texto del memo
    var tonUri = 'ton://transfer/' + ADDRESS + '?text=' + encodeURIComponent(MEMO);
    try {
      var qr = new QRCode(el('ton-qr-container'), {
        text: tonUri,
        width: 160, height: 160,
        colorDark: '#000000', colorLight: '#ffffff',
        correctLevel: QRCode.CorrectLevel.M
      });
      // Remove the canvas element since QRCode lib creates its own
      if (canvas.parentNode) canvas.parentNode.removeChild(canvas);
    } catch(e) {
      // Fallback: draw simple QR placeholder
      if (canvas) {
        var ctx = canvas.getContext('2d');
        ctx.fillStyle = '#fff';
        ctx.fillRect(0,0,160,160);
        ctx.fillStyle = '#0098EA';
        ctx.font = '10px monospace';
        ctx.fillText('QR: ' + ADDRESS.slice(0,10) + '...', 5, 20);
      }
    }
  }

  function copyDepAddr() {
    var addr = ADDRESS;
    if (!addr) return;
    navigator.clipboard.writeText(addr).then(function() {
      var btn = el('ton-copy-addr-btn');
      if (btn) { btn.textContent = '✓ OK'; setTimeout(function(){ btn.textContent = '{{ t.wl_copy }}'; }, 2000); }
    });
  }
  window.copyDepAddr = copyDepAddr;

  function copyDepMemo() {
    navigator.clipboard.writeText(MEMO).then(function() {
      var btn = el('ton-copy-memo-btn');
      if (btn) { btn.textContent = '✓ OK'; setTimeout(function(){ btn.textContent = '{{ t.wl_copy }}'; }, 2000); }
    });
  }
  window.copyDepMemo = copyDepMemo;

  /* Start polling for deposit */
  async function startPolling(depositId) {
    DEPOSIT_ID = depositId;
    if (pollTimer) clearInterval(pollTimer);
    pollTimer = setInterval(async function() {
      try {
        var r = await fetch('/api/ton/deposit/status/' + DEPOSIT_ID);
        var d = await r.json();
        if (d.status === 'credited' || d.status === 'confirmed') {
          clearInterval(pollTimer);
          showDepStep('success');
          var msg = '✅ ' + d.ton_amount.toFixed(4) + ' TON recibidos\n';
          msg += '+ ' + d.doge_credited.toFixed(2) + ' DOGE acreditados a tu cuenta';
          el('ton-success-msg').textContent = msg;
        }
      } catch(e) { /* ignorar, seguir intentando */ }
    }, 8000);
  }

  /* Open deposit modal */
  el('ton-deposit-btn') && el('ton-deposit-btn').addEventListener('click', async function() {
    showDepStep('qr');
    DogeQuest.openModal('ton-deposit-modal');
    // Generate QR on first open
    if (!el('ton-qr-canvas') && !document.querySelector('#ton-qr-container img')) {
      generateQR();
    }
    // Get or create deposit ID for polling
    try {
      var r = await fetch('/api/ton/deposit/address');
      var d = await r.json();
      if (d.success) {
        startPolling(d.deposit_id);
      }
    } catch(e) {}
  });

  // Generate QR immediately on page load so it's ready
  document.addEventListener('DOMContentLoaded', function() {
    if (ADDRESS && !ADDRESS.includes('AQUI')) {
      setTimeout(generateQR, 300);
    }
  });

  /* Close modal */
  el('ton-modal-close') && el('ton-modal-close').addEventListener('click', function() {
    if (pollTimer) clearInterval(pollTimer);
    DogeQuest.closeModal('ton-deposit-modal');
  });
  el('ton-btn-cancel') && el('ton-btn-cancel').addEventListener('click', function() {
    if (pollTimer) clearInterval(pollTimer);
    DogeQuest.closeModal('ton-deposit-modal');
  });
  el('ton-btn-success-close') && el('ton-btn-success-close').addEventListener('click', function() {
    if (pollTimer) clearInterval(pollTimer);
    DogeQuest.closeModal('ton-deposit-modal');
    location.reload();
  });

})();
</script>
{% endif %}
{% endblock %}
