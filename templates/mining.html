{% extends "base.html" %}

{% block title %}Apple Farm - DogeQuest{% endblock %}

{% block content %}
<style>
@import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;500;600&display=swap');

:root {
  --bg:        #08080f;
  --surface:   #0d0d1a;
  --surface2:  #111122;
  --surface3:  #070710;
  --gold:      #ffd700;
  --gold2:     #ffb300;
  --gold-dark: #5a3a00;
  --gold-dim:  rgba(255,215,0,0.07);
  --green:     #00e676;
  --blue:      #40c4ff;
  --border:    #1e1e34;
  --text:      #e0e2f0;
  --text2:     #9090b8;
  --muted:     #4a4a6e;
  --font-px:   'Press Start 2P', monospace;
  --font-body: 'Inter', sans-serif;
}

.mn-shell *, .mn-shell *::before, .mn-shell *::after { box-sizing: border-box; }
.mn-shell {
  font-family: var(--font-body);
  background: var(--bg); min-height: 100vh;
  color: var(--text); position: relative; overflow-x: hidden;
}
.mn-shell::before {
  content:''; position:fixed; inset:0;
  background-image:
    linear-gradient(rgba(255,255,255,0.011) 1px, transparent 1px),
    linear-gradient(90deg,rgba(255,255,255,0.011) 1px, transparent 1px);
  background-size:24px 24px; pointer-events:none; z-index:0;
}
.mn-shell::after {
  content:''; position:fixed; inset:0;
  background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,0.055) 2px,rgba(0,0,0,0.055) 4px);
  pointer-events:none; z-index:1;
}
.mn-ticker {
  position:relative; z-index:20;
  background:var(--gold); height:28px;
  display:flex; align-items:center; overflow:hidden;
  border-bottom:3px solid var(--gold-dark);
}
.mn-ticker span {
  display:inline-block; white-space:nowrap;
  font-family:var(--font-px); font-size:0.42rem;
  color:#0a0800; letter-spacing:0.08em;
  animation:mn-tick 32s linear infinite;
}
@keyframes mn-tick{ from{transform:translateX(100vw)} to{transform:translateX(-100%)} }
.mn-page {
  position:relative; z-index:5;
  max-width:560px; margin:0 auto;
  padding:20px 14px 80px;
  display:flex; flex-direction:column; gap:14px;
}
.mn-card {
  background:var(--surface);
  border:2px solid var(--border);
  box-shadow:4px 4px 0 0 #030308;
  position:relative; padding:20px;
  animation:mn-up .3s ease both;
}
.mn-card::before,.mn-card::after {
  content:''; position:absolute; width:9px; height:9px;
  border-color:var(--gold); border-style:solid;
}
.mn-card::before{top:-2px;left:-2px;border-width:2px 0 0 2px}
.mn-card::after{bottom:-2px;right:-2px;border-width:0 2px 2px 0}
@keyframes mn-up{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.mn-label {
  font-family:var(--font-px); font-size:0.42rem;
  color:var(--muted); letter-spacing:0.18em; text-transform:uppercase;
  display:flex; align-items:center; gap:8px; margin-bottom:16px;
}
.mn-label::after{ content:''; flex:1; height:1px; background:var(--border); }

/* HERO */
.mn-hero {
  background: linear-gradient(160deg, #08080e 0%, #0c0c1e 100%);
  border: 2px solid var(--gold-dark);
  box-shadow: 4px 4px 0 0 #020201, 0 0 50px rgba(255,215,0,0.06);
  padding: 28px 20px 24px; text-align: center;
  position: relative; overflow: hidden;
  animation: mn-up .3s .04s ease both;
}
.mn-hero::before,.mn-hero::after {
  content:''; position:absolute; width:9px; height:9px;
  border-color:var(--gold); border-style:solid;
}
.mn-hero::before{top:-2px;left:-2px;border-width:2px 0 0 2px}
.mn-hero::after{bottom:-2px;right:-2px;border-width:0 2px 2px 0}
.mn-hero-glow {
  position:absolute; top:-40px; left:50%; transform:translateX(-50%);
  width:200px; height:200px;
  background:radial-gradient(circle,rgba(255,215,0,0.1) 0%,transparent 68%);
  pointer-events:none;
}
.mn-hero-icon {
  width:64px; height:64px;
  display:flex; align-items:center; justify-content:center;
  margin:0 auto 18px; font-size:2.5rem;
  animation: mn-bounce .8s steps(1) infinite;
}
@keyframes mn-bounce{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-3px)} }
.mn-hero-title {
  font-family:var(--font-px); font-size:0.75rem;
  color:var(--gold); text-shadow:2px 2px 0 var(--gold-dark), 0 0 16px rgba(255,215,0,0.3);
  letter-spacing:.07em; margin-bottom:10px;
}
.mn-hero-sub { font-size:0.8rem; color:var(--text2); line-height:1.5; }

/* STATS */
.mn-stats {
  display:grid; grid-template-columns:repeat(3,1fr); gap:0;
  border:2px solid var(--border);
}
.mn-stat {
  padding:16px 10px; text-align:center;
  background:var(--surface3); position:relative;
}
.mn-stat + .mn-stat::before {
  content:''; position:absolute; left:0; top:15%; bottom:15%;
  width:1px; background:var(--border);
}
.mn-stat-icon {
  width:34px; height:34px;
  background:var(--surface); border:2px solid var(--border);
  display:flex; align-items:center; justify-content:center;
  margin:0 auto 10px; font-size:1rem;
}
.mn-stat-val {
  display:block; font-family:var(--font-px); font-size:0.62rem;
  color:var(--gold); text-shadow:2px 2px 0 var(--gold-dark);
  margin-bottom:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}
.mn-stat-lbl { font-size:0.6rem; color:var(--muted); letter-spacing:.08em; text-transform:uppercase; }

/* HARVEST */
.mn-claim {
  background:#060612; border:2px solid rgba(0,230,118,0.3);
  box-shadow:4px 4px 0 0 #020205, 0 0 20px rgba(0,230,118,0.06);
  padding:16px 20px; position:relative;
}
.mn-claim::before,.mn-claim::after {
  content:''; position:absolute; width:9px; height:9px;
  border-color:var(--green); border-style:solid;
}
.mn-claim::before{top:-2px;left:-2px;border-width:2px 0 0 2px}
.mn-claim::after{bottom:-2px;right:-2px;border-width:0 2px 2px 0}
.mn-claim-btn {
  width:100%; padding:16px; display:flex; align-items:center; justify-content:center; gap:12px;
  font-family:var(--font-px); font-size:0.52rem; letter-spacing:.07em;
  background:var(--green); color:#050f08;
  border:2px solid #00c853;
  box-shadow:4px 4px 0 0 #003318;
  cursor:pointer; transition:transform .07s, box-shadow .07s;
  animation: mn-pulse 2s ease-in-out infinite;
}
@keyframes mn-pulse{
  0%,100%{box-shadow:4px 4px 0 0 #003318, 0 0 0 0 rgba(0,230,118,0)}
  50%{box-shadow:4px 4px 0 0 #003318, 0 0 0 6px rgba(0,230,118,0)}
}
.mn-claim-btn:hover  { transform:translate(-1px,-1px); box-shadow:5px 5px 0 0 #003318; animation:none; }
.mn-claim-btn:active { transform:translate(2px,2px); box-shadow:1px 1px 0 0 #003318; }
.mn-claim-btn:disabled{ opacity:.5; cursor:not-allowed; transform:none; animation:none; }

/* MY TREES */
.apple-status { display:flex; flex-direction:column; gap:8px; }
.apple-machine {
  background:var(--surface3); border:2px solid var(--border);
  box-shadow:2px 2px 0 0 #020205;
  display:flex; align-items:center; gap:12px; padding:12px 14px;
  position:relative;
}
.apple-machine::before {
  content:''; position:absolute; left:0; top:0; bottom:0; width:3px; background:var(--green);
}
.apple-machine-icon {
  flex-shrink:0; width:42px; height:42px;
  background:var(--surface); border:2px solid var(--border);
  display:flex; align-items:center; justify-content:center; font-size:1.3rem;
}
.apple-machine-body { flex:1; min-width:0; }
.apple-machine-name {
  display:block; font-family:var(--font-px); font-size:0.46rem;
  color:var(--text); letter-spacing:.04em; margin-bottom:5px;
}
.apple-machine-rate { font-size:0.7rem; color:var(--text2); }
.apple-machine-right { flex-shrink:0; text-align:right; }
.apple-machine-status {
  display:flex; align-items:center; gap:5px;
  font-family:var(--font-px); font-size:0.36rem;
  color:var(--green); letter-spacing:.06em;
  text-shadow:0 0 8px rgba(0,230,118,0.4); margin-bottom:5px;
}
.apple-status-dot {
  width:6px; height:6px; background:var(--green);
  box-shadow:0 0 6px rgba(0,230,118,0.6);
  animation:mn-dot 1s steps(1) infinite;
}
@keyframes mn-dot{ 0%,100%{opacity:1} 50%{opacity:0.2} }
.apple-machine-exp { font-size:0.6rem; color:var(--muted); }

/* TREE SHOP */
.tree-plans { display:flex; flex-direction:column; gap:14px; }
.tree-plan {
  position:relative; overflow:hidden;
  background:linear-gradient(160deg,#09091a,#06060f);
  border:1px solid rgba(255,255,255,0.07);
  border-radius:2px; padding:20px 18px 18px;
  transition:transform .15s, box-shadow .15s;
}
.tree-plan:hover { transform:translateY(-2px); }
.tree-plan::before { content:''; position:absolute; left:0; top:0; bottom:0; width:3px; }
.tree-plan::after  { content:''; position:absolute; top:0; left:0; right:0; height:1px; }

.tree-plan.silvestre { border-color:rgba(129,199,132,0.2); box-shadow:0 4px 24px rgba(129,199,132,0.06); }
.tree-plan.silvestre::before { background:#81C784; box-shadow:0 0 12px rgba(129,199,132,0.6); }
.tree-plan.silvestre::after  { background:linear-gradient(90deg,rgba(129,199,132,0.3),transparent); }
.tree-plan.fuji      { border-color:rgba(165,214,167,0.2); box-shadow:0 4px 24px rgba(165,214,167,0.06); }
.tree-plan.fuji::before { background:#A5D6A7; box-shadow:0 0 12px rgba(165,214,167,0.5); }
.tree-plan.fuji::after  { background:linear-gradient(90deg,rgba(165,214,167,0.25),transparent); }
.tree-plan.gala      { border-color:rgba(255,241,118,0.25); box-shadow:0 4px 24px rgba(255,241,118,0.07); }
.tree-plan.gala::before { background:#FFF176; box-shadow:0 0 14px rgba(255,241,118,0.7); }
.tree-plan.gala::after  { background:linear-gradient(90deg,rgba(255,241,118,0.25),transparent); }
.tree-plan.granny    { border-color:rgba(200,230,201,0.25); box-shadow:0 4px 24px rgba(200,230,201,0.06); }
.tree-plan.granny::before { background:#C8E6C9; box-shadow:0 0 14px rgba(200,230,201,0.6); }
.tree-plan.granny::after  { background:linear-gradient(90deg,rgba(200,230,201,0.25),transparent); }
.tree-plan.dorado    { border-color:rgba(255,249,196,0.3); box-shadow:0 4px 24px rgba(255,215,0,0.08); }
.tree-plan.dorado::before { background:#FFD700; box-shadow:0 0 16px rgba(255,215,0,0.7); }
.tree-plan.dorado::after  { background:linear-gradient(90deg,rgba(255,215,0,0.3),transparent); }
.tree-plan.mistico   { border-color:rgba(206,147,216,0.35); box-shadow:0 4px 32px rgba(206,147,216,0.1); }
.tree-plan.mistico::before { background:linear-gradient(180deg,#ce93d8,#7B1FA2); box-shadow:0 0 18px rgba(206,147,216,0.8); }
.tree-plan.mistico::after  { background:linear-gradient(90deg,rgba(206,147,216,0.35),transparent); }

/* Fallback for any other tier */
.tree-plan.starter::before,.tree-plan.basic::before,.tree-plan.pro::before,.tree-plan.elite::before,.tree-plan.master::before,.tree-plan.legendary::before { background:var(--gold); box-shadow:0 0 14px rgba(255,215,0,0.6); }
.tree-plan.starter::after,.tree-plan.basic::after,.tree-plan.pro::after,.tree-plan.elite::after,.tree-plan.master::after,.tree-plan.legendary::after  { background:linear-gradient(90deg,rgba(255,215,0,0.25),transparent); }

.tree-plan-head {
  display:flex; align-items:flex-start; justify-content:space-between;
  margin-bottom:16px; padding-left:8px;
}
.tree-plan-badge {
  display:inline-block; font-family:var(--font-px); font-size:0.3rem;
  letter-spacing:.16em; padding:3px 8px; margin-bottom:6px;
  border:1px solid rgba(255,215,0,0.4); border-radius:2px;
  color:var(--gold); background:rgba(255,215,0,0.06);
}
.tree-plan-name { display:block; font-family:var(--font-px); font-size:0.68rem; color:#fff; letter-spacing:.04em; }
.tree-plan-price-block { text-align:right; }
.tree-plan-price { display:block; font-family:var(--font-px); font-size:0.9rem; line-height:1; color:var(--gold); text-shadow:0 0 16px rgba(255,215,0,0.5); }
.tree-plan-price-unit { font-size:0.34rem; opacity:0.7; display:block; margin-top:3px; font-family:var(--font-px); letter-spacing:.1em; }

/* Qty selector */
.tree-qty-row {
  display:flex; align-items:center; gap:12px;
  padding:10px; margin-bottom:14px;
  background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06);
  border-radius:2px;
}
.tree-qty-lbl { font-size:0.7rem; color:var(--text2); flex:1; }
.tree-qty-controls { display:flex; align-items:center; gap:8px; }
.tree-qty-btn {
  width:28px; height:28px; font-family:var(--font-px); font-size:0.7rem;
  background:var(--surface3); border:2px solid var(--border);
  color:var(--text2); cursor:pointer; display:flex; align-items:center; justify-content:center;
  transition:border-color .1s, color .1s;
}
.tree-qty-btn:hover { border-color:var(--gold); color:var(--gold); }
.tree-qty-num { font-family:var(--font-px); font-size:0.6rem; color:var(--gold); min-width:24px; text-align:center; }

/* Metrics */
.tree-plan-metrics {
  display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px;
  padding:0 8px; margin-bottom:16px;
}
.tree-plan-metric {
  background:rgba(255,255,255,0.03); border:1px solid rgba(255,255,255,0.06);
  padding:10px 6px; text-align:center; border-radius:2px;
}
.tree-plan-metric-val {
  display:block; font-family:var(--font-px); font-size:0.46rem;
  color:#fff; margin-bottom:4px;
  overflow:hidden; text-overflow:ellipsis; white-space:nowrap;
}
.tree-plan-metric-lbl { display:block; font-size:0.6rem; color:var(--muted); letter-spacing:.06em; }

/* Buy btn */
.tree-btn-buy {
  width:100%; padding:14px; display:flex; align-items:center; justify-content:center; gap:8px;
  font-family:var(--font-px); font-size:0.44rem; letter-spacing:.1em;
  cursor:pointer; border:2px solid var(--gold); border-radius:2px;
  background:rgba(255,215,0,0.1); color:var(--gold);
  box-shadow:0 4px 20px rgba(255,215,0,0.15);
  transition:transform .1s, box-shadow .1s, opacity .1s;
}
.tree-btn-buy:hover  { transform:translateY(-1px); background:rgba(255,215,0,0.18); }
.tree-btn-buy:active { transform:translateY(1px); opacity:0.85; }
.tree-btn-buy:disabled { opacity:.4; cursor:not-allowed; transform:none; }

/* MODAL */
.mn-modal-bg {
  display:none; position:fixed; inset:0;
  background:rgba(4,4,10,0.9); z-index:100;
  align-items:center; justify-content:center;
}
.mn-modal-bg.show { display:flex; animation:mn-modal-bg .2s ease; }
@keyframes mn-modal-bg{ from{opacity:0} to{opacity:1} }
.mn-modal {
  background:var(--surface2); border:2px solid var(--border);
  box-shadow:0 0 40px rgba(0,0,0,0.7);
  width:90%; max-width:400px; padding:28px 20px 32px;
  position:relative; animation:mn-sheet .25s cubic-bezier(.22,.77,.42,1) both;
}
@keyframes mn-sheet{ from{transform:translateY(60px);opacity:0} to{transform:translateY(0);opacity:1} }
.mn-modal::before,.mn-modal::after { content:''; position:absolute; width:9px; height:9px; border-color:var(--gold); border-style:solid; }
.mn-modal::before{top:-2px;left:-2px;border-width:2px 0 0 2px}
.mn-modal::after{top:-2px;right:-2px;border-width:2px 2px 0 0}
.mn-modal-handle { width:36px; height:4px; background:var(--border); margin:0 auto 22px; }
.mn-modal-icon { width:50px; height:50px; display:flex; align-items:center; justify-content:center; margin:0 auto 16px; font-size:2rem; }
.mn-modal-title { font-family:var(--font-px); font-size:0.62rem; color:var(--text); text-align:center; letter-spacing:.06em; margin-bottom:10px; }
.mn-modal-msg { font-size:0.82rem; color:var(--text2); text-align:center; margin-bottom:20px; line-height:1.5; }
.mn-modal-details { display:flex; flex-direction:column; gap:8px; margin-bottom:22px; }
.mn-detail-row { display:flex; justify-content:space-between; align-items:center; background:var(--surface3); border:1px solid var(--border); padding:10px 14px; }
.mn-detail-lbl { font-size:0.72rem; color:var(--text2); }
.mn-detail-val { font-family:var(--font-px); font-size:0.44rem; color:var(--gold); text-shadow:1px 1px 0 var(--gold-dark); }
.mn-modal-btns { display:grid; grid-template-columns:1fr 2fr; gap:10px; }
.mn-btn-cancel { font-family:var(--font-px); font-size:0.44rem; letter-spacing:.06em; padding:14px; background:transparent; color:var(--text2); border:2px solid var(--border); box-shadow:2px 2px 0 0 #030308; cursor:pointer; }
.mn-btn-confirm { font-family:var(--font-px); font-size:0.5rem; letter-spacing:.06em; padding:14px; background:var(--gold); color:#0a0800; border:2px solid var(--gold2); box-shadow:3px 3px 0 0 var(--gold-dark); cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; transition:transform .07s, box-shadow .07s; }
.mn-btn-confirm:hover  { transform:translate(-1px,-1px); box-shadow:4px 4px 0 0 var(--gold-dark); }
.mn-btn-confirm:active { transform:translate(2px,2px); box-shadow:1px 1px 0 0 var(--gold-dark); }
.mn-btn-confirm:disabled { opacity:.5; cursor:not-allowed; transform:none; }
.mn-spinner { display:inline-block; width:10px; height:10px; border:2px solid rgba(0,0,0,0.3); border-top-color:#0a0800; animation:mn-spin .4s steps(4) infinite; }
@keyframes mn-spin{ from{transform:rotate(0)} to{transform:rotate(360deg)} }

/* Float apple */
.float-apple { position:fixed; font-size:1.4rem; pointer-events:none; z-index:9999; animation: float-up 1.2s ease-out forwards; }
@keyframes float-up { 0%{opacity:1;transform:translateY(0) scale(1)} 100%{opacity:0;transform:translateY(-80px) scale(1.4)} }

/* How it works */
.mn-steps { display:flex; align-items:flex-start; justify-content:space-between; gap:4px; }
.mn-step { display:flex; flex-direction:column; align-items:center; gap:8px; flex:1; }
.mn-step-num { width:24px; height:24px; background:var(--gold); color:#0a0800; font-family:var(--font-px); font-size:0.48rem; display:flex; align-items:center; justify-content:center; box-shadow:2px 2px 0 0 var(--gold-dark); }
.mn-step-icon { width:36px; height:36px; background:var(--surface3); border:2px solid var(--border); display:flex; align-items:center; justify-content:center; font-size:1.1rem; }
.mn-step-lbl { font-size:0.6rem; color:var(--text2); text-align:center; line-height:1.5; max-width:58px; }
.mn-step-arrow { font-family:var(--font-px); font-size:0.5rem; color:var(--muted); margin-top:20px; flex-shrink:0; }
</style>

<div class="mn-shell">
  <div class="mn-ticker" aria-hidden="true">
    <span>
      üçé APPLE FARM ‚òÖ&nbsp;&nbsp;
      COMPRA √ÅRBOLES Y GANA MANZANAS AUTOM√ÅTICAMENTE &nbsp;‚òÖ&nbsp;&nbsp;
      COSECHAR MANZANAS = GANAR TON &nbsp;‚òÖ&nbsp;&nbsp;
      M√ÅS √ÅRBOLES = M√ÅS üçé POR HORA &nbsp;‚òÖ&nbsp;&nbsp;
      CULTIVA TU GRANJA PIXEL &nbsp;‚òÖ&nbsp;&nbsp;
    </span>
  </div>

  <div class="mn-page">

    <!-- HERO -->
    <div class="mn-hero">
      <div class="mn-hero-glow" aria-hidden="true"></div>
      <div class="mn-hero-icon">üçé</div>
      <div class="mn-hero-title">APPLE FARM</div>
      <div class="mn-hero-sub">Planta √°rboles y cosecha manzanas autom√°ticamente. ¬°Convi√©rtelas en TON!</div>
    </div>

    <!-- STATS -->
    <div class="mn-card" style="padding:0; overflow:hidden;">
      <div class="mn-stats">
        <div class="mn-stat">
          <div class="mn-stat-icon">üå≥</div>
          <span class="mn-stat-val" id="stat-trees">{{ mining_stats.total_machines if mining_stats else 0 }}</span>
          <span class="mn-stat-lbl">√Årboles</span>
        </div>
        <div class="mn-stat" style="background:rgba(255,215,0,0.03); border-top:2px solid rgba(255,215,0,0.12);">
          <div class="mn-stat-icon" style="border-color:var(--gold-dark); background:var(--gold-dim);">üçé</div>
          <span class="mn-stat-val" id="stat-rate">{{ (mining_stats.total_hourly_rate if mining_stats else 0)|int }}</span>
          <span class="mn-stat-lbl">Manz./Hora</span>
        </div>
        <div class="mn-stat">
          <div class="mn-stat-icon" style="border-color:rgba(0,230,118,0.25); background:rgba(0,230,118,0.04);">üì¶</div>
          <span class="mn-stat-val" id="stat-pending">{{ pending_rewards|int }}</span>
          <span class="mn-stat-lbl">Pendiente</span>
        </div>
      </div>
    </div>

    <!-- HARVEST -->
    {% if pending_rewards >= 1 %}
    <div class="mn-claim" id="harvest-section">
      <button class="mn-claim-btn" id="harvest-btn" onclick="harvestApples()">
        <span style="font-size:1.1rem;">üçé</span>
        COSECHAR <span id="harvest-amount">{{ pending_rewards|int }}</span> MANZANAS
      </button>
    </div>
    {% else %}
    <div class="mn-claim" id="harvest-section" style="display:none;">
      <button class="mn-claim-btn" id="harvest-btn" onclick="harvestApples()">
        <span style="font-size:1.1rem;">üçé</span>
        COSECHAR <span id="harvest-amount">0</span> MANZANAS
      </button>
    </div>
    {% endif %}

    <!-- MY TREES -->
    {% if user_machines %}
    <div class="mn-card">
      <div class="mn-label">üå≥ Mis √Årboles</div>
      <div class="apple-status">
        {% for machine in user_machines %}
        <div class="apple-machine">
          <div class="apple-machine-icon">
            {% if 'M√≠sico' in machine.plan_name or 'mistico' in machine.plan_name|lower %}üå∏
            {% elif 'Dorado' in machine.plan_name or 'dorado' in machine.plan_name|lower %}‚ú®
            {% elif 'Granny' in machine.plan_name or 'granny' in machine.plan_name|lower %}üåø
            {% elif 'Gala' in machine.plan_name or 'gala' in machine.plan_name|lower %}üåº
            {% elif 'Fuji' in machine.plan_name or 'fuji' in machine.plan_name|lower %}üçÉ
            {% else %}üå±
            {% endif %}
          </div>
          <div class="apple-machine-body">
            <span class="apple-machine-name">{{ machine.plan_name }}</span>
            <span class="apple-machine-rate">{{ machine.hourly_rate|int }} üçé/hr</span>
          </div>
          <div class="apple-machine-right">
            <div class="apple-machine-status">
              <div class="apple-status-dot"></div> ACTIVO
            </div>
            <div class="apple-machine-exp">
              Exp: {{ machine.expires_at.strftime('%Y-%m-%d') if machine.expires_at else 'N/A' }}
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    </div>
    {% endif %}

    <!-- TREE SHOP -->
    <div class="mn-card">
      <div class="mn-label">üõí Tienda de √Årboles</div>
      <p style="font-size:.78rem; color:var(--text2); margin-bottom:16px; line-height:1.5;">
        Cada √°rbol produce manzanas autom√°ticamente. M√°s √°rboles = m√°s manzanas por hora.
        Las manzanas cosechadas se suman a tu balance de TON.
      </p>

      {% if plans %}
      <div class="tree-plans">
        {% for plan in plans %}
        {% set tier_name = plan.tier|lower %}
        <div class="tree-plan {{ tier_name }}" id="plan-card-{{ plan.id }}">
          <div class="tree-plan-head">
            <div>
              <span class="tree-plan-badge">
                {% if tier_name == 'silvestre' %}üå± SILVESTRE
                {% elif tier_name == 'fuji' %}üçÉ FUJI
                {% elif tier_name == 'gala' %}üåº GALA
                {% elif tier_name == 'granny' %}üåø GRANNY
                {% elif tier_name == 'dorado' %}‚ú® DORADO
                {% elif tier_name == 'mistico' %}üå∏ M√çSTICO
                {% else %}{{ tier_name|upper }}
                {% endif %}
              </span>
              <span class="tree-plan-name">{{ plan.name }}</span>
            </div>
            <div class="tree-plan-price-block">
              <span class="tree-plan-price">
                {% if plan.price == 0 %}GRATIS{% else %}{{ plan.price|int }} TON{% endif %}
              </span>
              <span class="tree-plan-price-unit">POR √ÅRBOL</span>
            </div>
          </div>

          <!-- Qty selector -->
          <div class="tree-qty-row">
            <span class="tree-qty-lbl">Cantidad a plantar</span>
            <div class="tree-qty-controls">
              <button class="tree-qty-btn" onclick="changeQty({{ plan.id }}, -1)">‚àí</button>
              <span class="tree-qty-num" id="qty-{{ plan.id }}">1</span>
              <button class="tree-qty-btn" onclick="changeQty({{ plan.id }}, 1)">+</button>
            </div>
          </div>

          <!-- Metrics -->
          <div class="tree-plan-metrics">
            <div class="tree-plan-metric">
              <span class="tree-plan-metric-val" id="metric-ph-{{ plan.id }}">{{ plan.hourly_rate|int }}</span>
              <span class="tree-plan-metric-lbl">üçé/hora</span>
            </div>
            <div class="tree-plan-metric">
              <span class="tree-plan-metric-val" id="metric-pd-{{ plan.id }}">{{ (plan.hourly_rate * 24)|int }}</span>
              <span class="tree-plan-metric-lbl">üçé/d√≠a</span>
            </div>
            <div class="tree-plan-metric">
              <span class="tree-plan-metric-val" id="metric-cost-{{ plan.id }}">
                {% if plan.price == 0 %}GRATIS{% else %}{{ plan.price|int }} TON{% endif %}
              </span>
              <span class="tree-plan-metric-lbl">Costo Total</span>
            </div>
          </div>

          <button class="tree-btn-buy" id="buy-btn-{{ plan.id }}"
            onclick="openBuyModal({{ plan.id }}, '{{ plan.name }}', {{ plan.price }}, {{ plan.hourly_rate }})">
            {% if plan.price == 0 %}üå± PLANTAR GRATIS{% else %}üçé PLANTAR ({{ plan.price|int }} TON){% endif %}
          </button>
        </div>
        {% endfor %}
      </div>

      {% else %}
      <div style="padding:40px 20px; text-align:center;">
        <div style="font-size:2.5rem; margin-bottom:12px;">üå±</div>
        <div style="font-family:var(--font-px); font-size:0.5rem; color:var(--text2); margin-bottom:10px;">NO HAY √ÅRBOLES DISPONIBLES</div>
        <div style="font-size:0.78rem; color:var(--muted);">¬°Vuelve pronto para ver nuevos √°rboles!</div>
      </div>
      {% endif %}
    </div>

    <!-- HOW IT WORKS -->
    <div class="mn-card">
      <div class="mn-label">üí° C√≥mo Funciona</div>
      <div class="mn-steps">
        <div class="mn-step">
          <div class="mn-step-num">1</div>
          <div class="mn-step-icon">üõí</div>
          <div class="mn-step-lbl">Compra un √°rbol</div>
        </div>
        <div class="mn-step-arrow">‚Üí</div>
        <div class="mn-step">
          <div class="mn-step-num">2</div>
          <div class="mn-step-icon">üçé</div>
          <div class="mn-step-lbl">Produce manzanas solo</div>
        </div>
        <div class="mn-step-arrow">‚Üí</div>
        <div class="mn-step">
          <div class="mn-step-num">3</div>
          <div class="mn-step-icon">üì¶</div>
          <div class="mn-step-lbl">Cosecha cuando quieras</div>
        </div>
        <div class="mn-step-arrow">‚Üí</div>
        <div class="mn-step">
          <div class="mn-step-num">4</div>
          <div class="mn-step-icon">üí∞</div>
          <div class="mn-step-lbl">¬°Gana TON!</div>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- BUY MODAL -->
<div id="buyModal" class="mn-modal-bg">
  <div class="mn-modal">
    <div class="mn-modal-handle"></div>
    <div class="mn-modal-icon">üå≥</div>
    <div class="mn-modal-title">PLANTAR √ÅRBOL</div>
    <p class="mn-modal-msg" id="modal-msg">¬øPlantar este √°rbol?</p>
    <div class="mn-modal-details">
      <div class="mn-detail-row">
        <span class="mn-detail-lbl">√Årboles a plantar</span>
        <span class="mn-detail-val" id="modal-qty">1</span>
      </div>
      <div class="mn-detail-row">
        <span class="mn-detail-lbl">Costo total</span>
        <span class="mn-detail-val" id="modal-cost">0 TON</span>
      </div>
      <div class="mn-detail-row">
        <span class="mn-detail-lbl">Producci√≥n</span>
        <span class="mn-detail-val" id="modal-rate">0 üçé/hr</span>
      </div>
      <div class="mn-detail-row">
        <span class="mn-detail-lbl">Tu balance</span>
        <span class="mn-detail-val">{{ format_ton(user.doge_balance) }} TON</span>
      </div>
    </div>
    <div class="mn-modal-btns">
      <button class="mn-btn-cancel" onclick="closeBuyModal()">CANCELAR</button>
      <button class="mn-btn-confirm" id="modal-confirm-btn" onclick="confirmBuy()">
        üå± PLANTAR
      </button>
    </div>
  </div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê PLAN DATA ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const PLANS = {
  {% for plan in plans %}
  {{ plan.id }}: { id: {{ plan.id }}, name: '{{ plan.name }}', price: {{ plan.price }}, ph: {{ plan.hourly_rate }} },
  {% endfor %}
};
const QTY = {};
{% for plan in plans %}QTY[{{ plan.id }}] = 1;{% endfor %}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê REAL-TIME APPLE COUNTER ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let pendingApples = {{ pending_rewards|float }};
let applesPerHour = {{ (mining_stats.total_hourly_rate if mining_stats else 0)|float }};
let lastTick = Date.now();

function fmt(n) {
  if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
  if (n >= 1e3) return (n / 1e3).toFixed(1) + 'k';
  return Math.floor(n).toString();
}

function tick() {
  const now = Date.now();
  const dt = (now - lastTick) / 1000;
  lastTick = now;

  if (applesPerHour > 0) {
    pendingApples += (applesPerHour / 3600) * dt;
  }

  const pending = Math.floor(pendingApples);

  // Update pending display
  const sp = document.getElementById('stat-pending');
  if (sp) sp.textContent = fmt(pending);

  const ha = document.getElementById('harvest-amount');
  if (ha) ha.textContent = fmt(pending);

  // Show harvest section when apples available
  const hs = document.getElementById('harvest-section');
  if (hs) hs.style.display = pending >= 1 ? 'block' : 'none';
}

setInterval(tick, 500);
tick();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê QTY SELECTOR ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function changeQty(planId, delta) {
  QTY[planId] = Math.max(1, (QTY[planId] || 1) + delta);
  const plan = PLANS[planId];
  if (!plan) return;
  const qty = QTY[planId];

  const qtyEl = document.getElementById('qty-' + planId);
  if (qtyEl) qtyEl.textContent = qty;

  const costEl = document.getElementById('metric-cost-' + planId);
  if (costEl) costEl.textContent = plan.price === 0 ? 'GRATIS' : (plan.price * qty) + ' TON';

  const phEl = document.getElementById('metric-ph-' + planId);
  if (phEl) phEl.textContent = Math.floor(plan.ph * qty);

  const pdEl = document.getElementById('metric-pd-' + planId);
  if (pdEl) pdEl.textContent = Math.floor(plan.ph * qty * 24);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê BUY MODAL ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let buyPlanId = null;

function openBuyModal(planId, planName, price, ph) {
  const qty = QTY[planId] || 1;
  buyPlanId = planId;
  document.getElementById('modal-msg').textContent = '¬øPlantar ' + qty + ' √°rbol' + (qty > 1 ? 'es' : '') + ' ' + planName + '?';
  document.getElementById('modal-qty').textContent = qty;
  document.getElementById('modal-cost').textContent = price === 0 ? '‚ú® GRATIS' : (price * qty) + ' TON';
  document.getElementById('modal-rate').textContent = Math.floor(ph * qty) + ' üçé/hr';
  document.getElementById('buyModal').classList.add('show');
}

function closeBuyModal() {
  document.getElementById('buyModal').classList.remove('show');
  buyPlanId = null;
}

async function confirmBuy() {
  if (!buyPlanId) return;
  const btn = document.getElementById('modal-confirm-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="mn-spinner"></span> PLANTANDO...';

  const qty = QTY[buyPlanId] || 1;
  let successCount = 0;

  for (let i = 0; i < qty; i++) {
    try {
      const res = await fetch('/api/mining/purchase', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plan_id: buyPlanId })
      });
      const data = await res.json();
      if (data.success) successCount++;
      else {
        showToast(data.message || 'Error al plantar √°rbol', 'error');
        break;
      }
    } catch (e) {
      showToast('Error de conexi√≥n', 'error');
      break;
    }
  }

  if (successCount > 0) {
    closeBuyModal();
    spawnApples(Math.min(successCount * 3, 15));
    showToast('üå≥ +' + successCount + ' √°rbol' + (successCount > 1 ? 'es' : '') + ' plantado' + (successCount > 1 ? 's' : '') + '!', 'success');
    setTimeout(() => location.reload(), 1600);
  }

  btn.disabled = false;
  btn.innerHTML = 'üå± PLANTAR';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê HARVEST ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function harvestApples() {
  const btn = document.getElementById('harvest-btn');
  if (!btn || btn.disabled) return;
  btn.disabled = true;
  btn.innerHTML = '<span class="mn-spinner"></span> COSECHANDO...';

  try {
    const res = await fetch('/api/mining/claim', { method: 'POST', headers: { 'Content-Type': 'application/json' } });
    const data = await res.json();
    if (data.success) {
      const harvested = Math.floor(pendingApples);
      spawnApples(Math.min(harvested, 20));
      showToast(data.message || 'üçé ¬°Cosecha exitosa!', 'success');
      pendingApples = 0;
      tick();
      setTimeout(() => location.reload(), 1600);
    } else {
      showToast(data.message || 'Error al cosechar', 'error');
      btn.disabled = false;
      btn.innerHTML = '<span style="font-size:1.1rem;">üçé</span> COSECHAR ' + fmt(Math.floor(pendingApples)) + ' MANZANAS';
    }
  } catch (e) {
    showToast('Error de conexi√≥n', 'error');
    btn.disabled = false;
    btn.innerHTML = '<span style="font-size:1.1rem;">üçé</span> COSECHAR ' + fmt(Math.floor(pendingApples)) + ' MANZANAS';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê ANIMATIONS ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function spawnApples(count) {
  for (let i = 0; i < count; i++) {
    setTimeout(() => {
      const el = document.createElement('div');
      el.className = 'float-apple';
      el.textContent = 'üçé';
      el.style.left = (15 + Math.random() * 70) + 'vw';
      el.style.top  = (20 + Math.random() * 50) + 'vh';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1300);
    }, i * 60);
  }
  if (window.DogeQuest && window.DogeQuest.createCoinRain) {
    window.DogeQuest.createCoinRain(8);
  }
}

function showToast(m, t) {
  if (window.DogeQuest && window.DogeQuest.showToast) window.DogeQuest.showToast(m, t);
  else alert(m);
}

// Close modal on backdrop
document.getElementById('buyModal').addEventListener('click', function(e) {
  if (e.target === this) closeBuyModal();
});
</script>
{% endblock %}